# OpenVPN Flutter Client

A cross-platform OpenVPN client built with Flutter with **native OpenVPN3 integration**.

## NOTE: This project is fully generated by AI coding agent

## âœ… Current Status

**FULLY FUNCTIONAL** - Android and macOS implementations are complete and working with real OpenVPN3 integration!

### Working Features
- âœ… **Native OpenVPN3 Integration**: Real OpenVPN connections using OpenVPN3 Core library
- âœ… **Android Support**: Fully functional with NDK 27.0.12077973
- âœ… **macOS Support**: Fully functional with real system VPN integration
- âœ… **Real-time Status Updates**: Live connection status and statistics
- âœ… **VPN IP Display**: Persistent VPN IP address display throughout connection
- âœ… **Configuration Import**: Support for .ovpn configuration files
- âœ… **VPN Interface Management**: Platform-specific VPN implementations
- âœ… **Authorization Handling**: Proper privilege management (macOS admin auth)
- âœ… **Threading Safety**: Proper main thread handling for UI updates
- âœ… **Connection Lifecycle**: Connect, authenticate, disconnect flow
- âœ… **Multiple Connect/Disconnect Cycles**: Reliable reconnection support

### Platform Status
- ğŸŸ¢ **Android**: Fully implemented and tested with real OpenVPN3 (TUN_NULL mode)
- ğŸŸ¢ **macOS**: Fully implemented and tested with real system VPN (utun interfaces)
- ğŸŸ¡ **iOS**: Planned (requires Apple Developer signing)
- ğŸŸ¡ **Windows**: Planned
- ğŸŸ¡ **Linux**: Planned

## Project Structure

The project has been restructured for better cross-platform support:

```
fl_openvpn_client/
â”œâ”€â”€ lib/                          # Flutter/Dart source code
â”‚   â”œâ”€â”€ models/                   # Data models
â”‚   â”œâ”€â”€ providers/                # State management (Provider pattern)
â”‚   â”œâ”€â”€ screens/                  # UI screens
â”‚   â”œâ”€â”€ services/                 # Business logic and native integration
â”‚   â””â”€â”€ widgets/                  # Reusable UI components
â”œâ”€â”€ android/                      # Android-specific code
â”‚   â””â”€â”€ app/
â”‚       â””â”€â”€ src/main/
â”‚           â”œâ”€â”€ cpp/              # Minimal Android JNI wrapper
â”‚           â”‚   â”œâ”€â”€ CMakeLists.txt    # Links to openvpn/ directory
â”‚           â”‚   â””â”€â”€ android_compat.cpp # Android compatibility layer
â”‚           â””â”€â”€ kotlin/           # Android Kotlin code
â”œâ”€â”€ openvpn/                      # ğŸ†• Cross-platform OpenVPN library
â”‚   â”œâ”€â”€ build_android.sh         # Android build script
â”‚   â”œâ”€â”€ openvpn_jni.cpp          # Main JNI implementation
â”‚   â”œâ”€â”€ build/                    # Build artifacts (ignored by git)
â”‚   â”‚   â”œâ”€â”€ deps/                 # External dependencies
â”‚   â”‚   â”‚   â”œâ”€â”€ asio/             # ASIO networking library (v1.30.2)
â”‚   â”‚   â”‚   â”œâ”€â”€ fmt/              # Formatting library (v11.0.2)
â”‚   â”‚   â”‚   â”œâ”€â”€ lz4/              # Compression library (v1.10.0)
â”‚   â”‚   â”‚   â”œâ”€â”€ openssl/          # OpenSSL cryptography (v3.3.2)
â”‚   â”‚   â”‚   â””â”€â”€ openvpn3-core/    # OpenVPN3 Core library (v3.11.1)
â”‚   â”‚   â””â”€â”€ android/              # Android build outputs
â”‚   â”‚       â””â”€â”€ {arch}/           # Architecture-specific builds
â”‚   â”‚           â”œâ”€â”€ install/      # Compiled libraries
â”‚   â”‚           â””â”€â”€ lib/          # Final .so files
â”œâ”€â”€ ios/                          # iOS-specific code (future)
â”œâ”€â”€ assets/                       # Static assets (images, fonts, etc.)
â”œâ”€â”€ sample_configs/               # Sample OpenVPN configuration files
â”œâ”€â”€ udp_forwarder.py             # UDP forwarding utility for emulator testing
â””â”€â”€ build_project.sh             # ğŸ†• Main project build script
```

### Key Improvements
- **ğŸ”„ Reusable OpenVPN Library**: The `openvpn/` directory contains a standalone library that can be used across all platforms
- **ğŸ¤– Automated Dependency Management**: Build scripts automatically clone and build all dependencies with pinned stable versions
- **ğŸ—ï¸ Clean Build System**: Dependencies are built outside the source tree in `openvpn/build/` (ignored by git)
- **ğŸ“¦ CMake Integration**: Minimal Android JNI wrapper links to the main OpenVPN library
- **ğŸ”’ Stable Dependencies**: All dependencies pinned to specific stable versions for reproducible builds
- **ğŸ§¹ Clean Source Tree**: Old embedded dependencies removed, only essential source files tracked by git

## Features

- ğŸ” **Real OpenVPN3 Integration**: Uses native OpenVPN3 Core library for actual VPN connections
- ğŸ“± **Android Support**: Fully functional Android implementation
- ğŸ“„ **Configuration Import**: Import .ovpn configuration files
- âš™ï¸ **Manual Configuration**: Create configurations manually with an intuitive UI
- ğŸ”’ **Secure Storage**: Credentials stored securely using platform-specific secure storage
- ğŸ“Š **Real-time Monitoring**: Live connection status, VPN IP address, data usage, and connection time
- ğŸ¨ **Modern UI**: Clean, Material Design interface with dark/light theme support
- ğŸ”„ **Connection Management**: Complete connect/authenticate/disconnect lifecycle
- ğŸ“‹ **Multiple Configs**: Manage multiple VPN configurations

## Screenshots

The app features a modern, intuitive interface with:
- Connection status dashboard with animated indicators
- Server configuration management
- Real-time connection statistics
- Authentication dialogs for secure login

## ğŸš€ Quick Start

### ğŸ“‹ Prerequisites

- **Flutter SDK**: 3.32.4 or later
- **Dart SDK**: Latest stable version
- **Python 3**: For UDP forwarder (Android emulator testing)

#### ğŸ¤– Android Platform (âœ… Fully Working)
- **Android Studio**: Latest stable version
- **Android NDK**: 27.0.12077973 (exact version required)
- **Android SDK**: API 35 or later
- **CMake**: For native library compilation (included with Android Studio)

#### ğŸ macOS Platform (âœ… Fully Working)
- **Xcode**: Latest stable version with command line tools
- **macOS**: 10.15 (Catalina) or later
- **Administrator Privileges**: Required for TUN interface creation
- **Apple Developer Account**: Recommended for code signing

#### ğŸ“± iOS Platform (ğŸš§ Planned)
- **iOS**: Xcode (macOS only)
- **Apple Developer Account**: Required for Network Extension entitlements

#### ğŸ–¥ï¸ Other Platforms (ğŸš§ Planned)
- **Windows**: Visual Studio with C++ support
- **Linux**: GCC/Clang and development tools

### ğŸ”§ Installation & Build

#### ğŸ¯ One-Shot Android Build (Recommended)

```bash
# 1. Clone the repository
git clone <repository-url>
cd fl_openvpn_client

# 2. Set up Android NDK environment
export ANDROID_NDK_ROOT=/path/to/your/ndk/27.0.12077973
export ANDROID_ABI=x86_64  # For emulator, use arm64-v8a for device

# 3. Build everything in one shot (dependencies + APK)
./build_android.sh

# 4. For Android emulator testing, start UDP forwarder
python3 udp_forwarder.py &

# 5. Install and run
flutter install
```

#### ğŸ“± Step-by-Step Android Build

```bash
# 1. Clone and setup
git clone <repository-url>
cd fl_openvpn_client
flutter pub get

# 2. Build OpenVPN dependencies only
./build_android.sh --deps-only

# 3. Build Flutter APK
flutter build apk --debug
# OR for release
flutter build apk --release

# 4. Install APK
adb install build/app/outputs/flutter-apk/app-debug.apk
```

#### ğŸ› ï¸ Build Script Options

```bash
# Clean build (removes all build artifacts)
./build_android.sh --clean

# Build release APK
./build_android.sh --release

# Only build dependencies, skip Flutter build
./build_android.sh --deps-only

# Skip dependencies, only build Flutter APK
./build_android.sh --skip-deps

# Show help
./build_android.sh --help
```

#### ğŸ macOS Build (âœ… Fully Working)

```bash
# 1. Clone the repository
git clone <repository-url>
cd fl_openvpn_client

# 2. Build OpenVPN dependencies for macOS
cd macos
./build_openvpn.sh

# 3. Build and run Flutter app
cd ..
flutter run -d macos

# Note: The app will request administrator privileges on first connection
# This is required for creating real TUN interfaces on macOS
```

#### ğŸ–¥ï¸ Other Desktop Platforms (ğŸš§ Coming Soon)

```bash
# Build for other desktop platforms (planned)
flutter run -d windows
flutter run -d linux
```

## Usage

### Adding VPN Configurations

1. **Import .ovpn file**: Tap the "+" button and select "Import .ovpn file" to import an existing OpenVPN configuration
2. **Manual configuration**: Create a configuration manually by entering server details
3. **Sample configurations**: Load demo configurations for testing

### Connecting to VPN

1. Select a configuration from the server list
2. Tap the "Connect" button
3. Enter credentials if required
4. Monitor connection status and statistics

### Managing Configurations

- Tap on any configuration to set it as active
- Use the menu (â‹®) to edit or delete configurations
- View connection history and statistics

## Architecture

The app follows a clean architecture pattern with:

- **Models**: Data structures for VPN configurations and status
- **Services**: VPN service abstraction and OpenVPN implementation
- **Providers**: State management using Provider pattern
- **Widgets**: Reusable UI components
- **Screens**: Main application screens
- **Utils**: Helper utilities for configuration parsing and storage

### Key Components

- `VpnProvider`: Main state management for VPN operations
- `OpenVpnService`: Platform-specific VPN service implementation
- `ConfigParser`: OpenVPN configuration file parser
- `StorageHelper`: Secure storage with fallback to file storage

## Platform-Specific Implementation

### Android âœ… (Fully Implemented)

**Real OpenVPN3 integration with native library compilation:**

**Key Components:**
- **Native Library**: `libopenvpn_native.so` compiled with CMake
- **OpenVPN3 Core**: Full OpenVPN3 Core library integration
- **NDK Version**: 27.0.12077973 (aligned across all dependencies)
- **Service Type**: `specialUse` foreground service for VPN functionality
- **Threading**: Proper main thread handling for Flutter integration
- **Permissions**: All required VPN and foreground service permissions

**Build Configuration:**
- CMakeLists.txt compiles OpenVPN3 Core with ASIO and OpenSSL
- JNI bindings for Flutter â†” Native communication
- Kotlin service layer for Android VPN management

**Testing Status:**
- âœ… Tested with real OpenVPN server (Ubuntu 24.04)
- âœ… Complete connection lifecycle working
- âœ… Real-time status updates functional
- âœ… VPN IP address display working persistently
- âœ… Multiple connect/disconnect cycles tested
- âœ… Proper authentication handling
- âœ… Clean disconnect process

### macOS âœ… (Fully Implemented)

**Real system VPN integration with TUN interface creation:**

**Key Components:**
- **Native Library**: OpenVPN3 Core with macOS TUN client
- **Authorization**: macOS Authorization Services for admin privileges
- **TUN Interface**: Real utun interface creation (e.g., utun8)
- **App Sandbox**: Disabled for VPN functionality
- **Build System**: One-shot build script (`build_openvpn.sh`)
- **Privilege Management**: One-time authorization per app session

**Build Configuration:**
- CMakeLists.txt compiles OpenVPN3 Core with native macOS TUN client
- Swift integration for macOS Authorization Services
- Proper entitlements configuration for VPN functionality

**Testing Status:**
- âœ… Tested with real OpenVPN server (Ubuntu 24.04)
- âœ… Real TUN interface creation (utun8 with VPN IP 10.8.0.2)
- âœ… Administrator authorization dialog working
- âœ… One-time authorization per app session
- âœ… Complete connection lifecycle working
- âœ… Real-time status updates functional
- âœ… Multiple connect/disconnect cycles tested
- âœ… Proper system VPN integration

### iOS (Planned)
- Implement using NetworkExtension framework
- Configure VPN entitlements
- Handle iOS-specific VPN permissions

### Windows (Planned)
- Implement using Windows VPN APIs
- Handle Windows-specific networking

### Linux (Planned)
- Integrate with system OpenVPN client
- Handle Linux networking permissions

## Testing

### Manual Testing âœ… (Android)
- **Connection Flow**: Tested complete connect/disconnect cycle
- **Status Updates**: Verified real-time status reporting
- **Error Handling**: Tested various error conditions
- **Service Management**: Verified foreground service behavior

### Test Environment
- **Server**: Ubuntu 24.04 OpenVPN server (multipass)
- **Client**: Android emulator with API 35
- **Configuration**: Real .ovpn files with authentication

### Automated Testing (Planned)
```bash
flutter test
```

The project will include:
- Unit tests for models and utilities
- Widget tests for UI components
- Integration tests for VPN functionality

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests for new functionality
5. Ensure all tests pass
6. Submit a pull request

## Security Considerations

- Credentials are stored using platform-specific secure storage
- Configuration files are validated before import
- Network traffic is encrypted using OpenVPN protocols
- No sensitive data is logged in production builds

## License

This project is licensed under the MIT License - see the LICENSE file for details.

## Acknowledgments

- Flutter team for the excellent cross-platform framework
- OpenVPN community for the robust VPN protocol
- Contributors and testers who helped improve the app

## Documentation

### Technical Documentation
- **[Technical Summary](TECHNICAL_SUMMARY.md)**: Complete technical implementation details
- **[Current Status](CurrentStatus.md)**: Latest project status and achievements
- **[VPN IP Display Fix](VPN_IP_DISPLAY_FIX.md)**: Detailed fix for VPN IP persistence issue
- **[Build Guide](BUILD_GUIDE.md)**: Step-by-step build instructions
- **[VPN Development Guide](VPN_DEVELOPMENT_GUIDE.md)**: VPN development best practices

## Support

For issues, feature requests, or questions:
1. Check existing issues in the repository
2. Create a new issue with detailed information
3. Include platform, Flutter version, and error logs
4. Refer to the technical documentation for implementation details

## Troubleshooting

### Common Issues

1. **NDK Version Mismatch**:
   - Ensure NDK 27.0.12077973 is installed
   - Remove conflicting NDK versions
   - Clean and rebuild: `flutter clean && flutter run`

2. **Native Library Not Found**:
   - Verify CMakeLists.txt configuration
   - Check NDK path in local.properties
   - Ensure native library compilation is enabled

3. **Foreground Service Errors**:
   - Verify `specialUse` service type configuration
   - Check Android 14+ permission requirements
   - Ensure proper service property declaration

4. **VPN IP Not Displaying**:
   - Ensure connection is fully established (status shows "connected")
   - Check that stats polling is working (look for periodic stats logs)
   - Verify JNI method includes `localIp` field in returned HashMap
   - Check Flutter type casting in `getConnectionStats()` method

---

**Note**: The Android implementation is fully functional with real OpenVPN3 integration. Other platforms are planned for future development.
