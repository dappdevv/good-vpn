# OpenVPN Flutter Client

A cross-platform OpenVPN client built with Flutter with **native OpenVPN3 integration**.

## NOTE: This project is fully generated by AI coding agent

## ✅ Current Status

**FULLY FUNCTIONAL** - Android and macOS implementations are complete and working with real OpenVPN3 integration!

### Working Features
- ✅ **Native OpenVPN3 Integration**: Real OpenVPN connections using OpenVPN3 Core library
- ✅ **Android Support**: Fully functional with NDK 27.0.12077973
- ✅ **macOS Support**: Fully functional with real system VPN integration
- ✅ **Real-time Status Updates**: Live connection status and statistics
- ✅ **VPN IP Display**: Persistent VPN IP address display throughout connection
- ✅ **Configuration Import**: Support for .ovpn configuration files
- ✅ **VPN Interface Management**: Platform-specific VPN implementations
- ✅ **Authorization Handling**: Proper privilege management (macOS admin auth)
- ✅ **Threading Safety**: Proper main thread handling for UI updates
- ✅ **Connection Lifecycle**: Connect, authenticate, disconnect flow
- ✅ **Multiple Connect/Disconnect Cycles**: Reliable reconnection support

### Platform Status
- 🟢 **Android**: Fully implemented and tested with real OpenVPN3 (TUN_NULL mode)
- 🟢 **macOS**: Fully implemented and tested with real system VPN (utun interfaces)
- 🟡 **iOS**: Planned (requires Apple Developer signing)
- 🟡 **Windows**: Planned
- 🟡 **Linux**: Planned

## Project Structure

The project has been restructured for better cross-platform support:

```
fl_openvpn_client/
├── lib/                          # Flutter/Dart source code
│   ├── models/                   # Data models
│   ├── providers/                # State management (Provider pattern)
│   ├── screens/                  # UI screens
│   ├── services/                 # Business logic and native integration
│   └── widgets/                  # Reusable UI components
├── android/                      # Android-specific code
│   └── app/
│       └── src/main/
│           ├── cpp/              # Minimal Android JNI wrapper
│           │   ├── CMakeLists.txt    # Links to openvpn/ directory
│           │   └── android_compat.cpp # Android compatibility layer
│           └── kotlin/           # Android Kotlin code
├── openvpn/                      # 🆕 Cross-platform OpenVPN library
│   ├── build_android.sh         # Android build script
│   ├── openvpn_jni.cpp          # Main JNI implementation
│   ├── build/                    # Build artifacts (ignored by git)
│   │   ├── deps/                 # External dependencies
│   │   │   ├── asio/             # ASIO networking library (v1.30.2)
│   │   │   ├── fmt/              # Formatting library (v11.0.2)
│   │   │   ├── lz4/              # Compression library (v1.10.0)
│   │   │   ├── openssl/          # OpenSSL cryptography (v3.3.2)
│   │   │   └── openvpn3-core/    # OpenVPN3 Core library (v3.11.1)
│   │   └── android/              # Android build outputs
│   │       └── {arch}/           # Architecture-specific builds
│   │           ├── install/      # Compiled libraries
│   │           └── lib/          # Final .so files
├── ios/                          # iOS-specific code (future)
├── assets/                       # Static assets (images, fonts, etc.)
├── sample_configs/               # Sample OpenVPN configuration files
├── udp_forwarder.py             # UDP forwarding utility for emulator testing
└── build_project.sh             # 🆕 Main project build script
```

### Key Improvements
- **🔄 Reusable OpenVPN Library**: The `openvpn/` directory contains a standalone library that can be used across all platforms
- **🤖 Automated Dependency Management**: Build scripts automatically clone and build all dependencies with pinned stable versions
- **🏗️ Clean Build System**: Dependencies are built outside the source tree in `openvpn/build/` (ignored by git)
- **📦 CMake Integration**: Minimal Android JNI wrapper links to the main OpenVPN library
- **🔒 Stable Dependencies**: All dependencies pinned to specific stable versions for reproducible builds
- **🧹 Clean Source Tree**: Old embedded dependencies removed, only essential source files tracked by git

## Features

- 🔐 **Real OpenVPN3 Integration**: Uses native OpenVPN3 Core library for actual VPN connections
- 📱 **Android Support**: Fully functional Android implementation
- 📄 **Configuration Import**: Import .ovpn configuration files
- ⚙️ **Manual Configuration**: Create configurations manually with an intuitive UI
- 🔒 **Secure Storage**: Credentials stored securely using platform-specific secure storage
- 📊 **Real-time Monitoring**: Live connection status, VPN IP address, data usage, and connection time
- 🎨 **Modern UI**: Clean, Material Design interface with dark/light theme support
- 🔄 **Connection Management**: Complete connect/authenticate/disconnect lifecycle
- 📋 **Multiple Configs**: Manage multiple VPN configurations

## Screenshots

The app features a modern, intuitive interface with:
- Connection status dashboard with animated indicators
- Server configuration management
- Real-time connection statistics
- Authentication dialogs for secure login

## 🚀 Quick Start

### 📋 Prerequisites

- **Flutter SDK**: 3.32.4 or later
- **Dart SDK**: Latest stable version
- **Python 3**: For UDP forwarder (Android emulator testing)

#### 🤖 Android Platform (✅ Fully Working)
- **Android Studio**: Latest stable version
- **Android NDK**: 27.0.12077973 (exact version required)
- **Android SDK**: API 35 or later
- **CMake**: For native library compilation (included with Android Studio)

#### 🍎 macOS Platform (✅ Fully Working)
- **Xcode**: Latest stable version with command line tools
- **macOS**: 10.15 (Catalina) or later
- **Administrator Privileges**: Required for TUN interface creation
- **Apple Developer Account**: Recommended for code signing

#### 📱 iOS Platform (🚧 Planned)
- **iOS**: Xcode (macOS only)
- **Apple Developer Account**: Required for Network Extension entitlements

#### 🖥️ Other Platforms (🚧 Planned)
- **Windows**: Visual Studio with C++ support
- **Linux**: GCC/Clang and development tools

### 🔧 Installation & Build

#### 🎯 One-Shot Android Build (Recommended)

```bash
# 1. Clone the repository
git clone <repository-url>
cd fl_openvpn_client

# 2. Set up Android NDK environment
export ANDROID_NDK_ROOT=/path/to/your/ndk/27.0.12077973
export ANDROID_ABI=x86_64  # For emulator, use arm64-v8a for device

# 3. Build everything in one shot (dependencies + APK)
./build_android.sh

# 4. For Android emulator testing, start UDP forwarder
python3 udp_forwarder.py &

# 5. Install and run
flutter install
```

#### 📱 Step-by-Step Android Build

```bash
# 1. Clone and setup
git clone <repository-url>
cd fl_openvpn_client
flutter pub get

# 2. Build OpenVPN dependencies only
./build_android.sh --deps-only

# 3. Build Flutter APK
flutter build apk --debug
# OR for release
flutter build apk --release

# 4. Install APK
adb install build/app/outputs/flutter-apk/app-debug.apk
```

#### 🛠️ Build Script Options

```bash
# Clean build (removes all build artifacts)
./build_android.sh --clean

# Build release APK
./build_android.sh --release

# Only build dependencies, skip Flutter build
./build_android.sh --deps-only

# Skip dependencies, only build Flutter APK
./build_android.sh --skip-deps

# Show help
./build_android.sh --help
```

#### 🍎 macOS Build (✅ Fully Working)

```bash
# 1. Clone the repository
git clone <repository-url>
cd fl_openvpn_client

# 2. Build OpenVPN dependencies for macOS
cd macos
./build_openvpn.sh

# 3. Build and run Flutter app
cd ..
flutter run -d macos

# Note: The app will request administrator privileges on first connection
# This is required for creating real TUN interfaces on macOS
```

#### 🖥️ Other Desktop Platforms (🚧 Coming Soon)

```bash
# Build for other desktop platforms (planned)
flutter run -d windows
flutter run -d linux
```

## Usage

### Adding VPN Configurations

1. **Import .ovpn file**: Tap the "+" button and select "Import .ovpn file" to import an existing OpenVPN configuration
2. **Manual configuration**: Create a configuration manually by entering server details
3. **Sample configurations**: Load demo configurations for testing

### Connecting to VPN

1. Select a configuration from the server list
2. Tap the "Connect" button
3. Enter credentials if required
4. Monitor connection status and statistics

### Managing Configurations

- Tap on any configuration to set it as active
- Use the menu (⋮) to edit or delete configurations
- View connection history and statistics

## Architecture

The app follows a clean architecture pattern with:

- **Models**: Data structures for VPN configurations and status
- **Services**: VPN service abstraction and OpenVPN implementation
- **Providers**: State management using Provider pattern
- **Widgets**: Reusable UI components
- **Screens**: Main application screens
- **Utils**: Helper utilities for configuration parsing and storage

### Key Components

- `VpnProvider`: Main state management for VPN operations
- `OpenVpnService`: Platform-specific VPN service implementation
- `ConfigParser`: OpenVPN configuration file parser
- `StorageHelper`: Secure storage with fallback to file storage

## Platform-Specific Implementation

### Android ✅ (Fully Implemented)

**Real OpenVPN3 integration with native library compilation:**

**Key Components:**
- **Native Library**: `libopenvpn_native.so` compiled with CMake
- **OpenVPN3 Core**: Full OpenVPN3 Core library integration
- **NDK Version**: 27.0.12077973 (aligned across all dependencies)
- **Service Type**: `specialUse` foreground service for VPN functionality
- **Threading**: Proper main thread handling for Flutter integration
- **Permissions**: All required VPN and foreground service permissions

**Build Configuration:**
- CMakeLists.txt compiles OpenVPN3 Core with ASIO and OpenSSL
- JNI bindings for Flutter ↔ Native communication
- Kotlin service layer for Android VPN management

**Testing Status:**
- ✅ Tested with real OpenVPN server (Ubuntu 24.04)
- ✅ Complete connection lifecycle working
- ✅ Real-time status updates functional
- ✅ VPN IP address display working persistently
- ✅ Multiple connect/disconnect cycles tested
- ✅ Proper authentication handling
- ✅ Clean disconnect process

### macOS ✅ (Fully Implemented)

**Real system VPN integration with TUN interface creation:**

**Key Components:**
- **Native Library**: OpenVPN3 Core with macOS TUN client
- **Authorization**: macOS Authorization Services for admin privileges
- **TUN Interface**: Real utun interface creation (e.g., utun8)
- **App Sandbox**: Disabled for VPN functionality
- **Build System**: One-shot build script (`build_openvpn.sh`)
- **Privilege Management**: One-time authorization per app session

**Build Configuration:**
- CMakeLists.txt compiles OpenVPN3 Core with native macOS TUN client
- Swift integration for macOS Authorization Services
- Proper entitlements configuration for VPN functionality

**Testing Status:**
- ✅ Tested with real OpenVPN server (Ubuntu 24.04)
- ✅ Real TUN interface creation (utun8 with VPN IP 10.8.0.2)
- ✅ Administrator authorization dialog working
- ✅ One-time authorization per app session
- ✅ Complete connection lifecycle working
- ✅ Real-time status updates functional
- ✅ Multiple connect/disconnect cycles tested
- ✅ Proper system VPN integration

### iOS (Planned)
- Implement using NetworkExtension framework
- Configure VPN entitlements
- Handle iOS-specific VPN permissions

### Windows (Planned)
- Implement using Windows VPN APIs
- Handle Windows-specific networking

### Linux (Planned)
- Integrate with system OpenVPN client
- Handle Linux networking permissions

## Testing

### Manual Testing ✅ (Android)
- **Connection Flow**: Tested complete connect/disconnect cycle
- **Status Updates**: Verified real-time status reporting
- **Error Handling**: Tested various error conditions
- **Service Management**: Verified foreground service behavior

### Test Environment
- **Server**: Ubuntu 24.04 OpenVPN server (multipass)
- **Client**: Android emulator with API 35
- **Configuration**: Real .ovpn files with authentication

### Automated Testing (Planned)
```bash
flutter test
```

The project will include:
- Unit tests for models and utilities
- Widget tests for UI components
- Integration tests for VPN functionality

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests for new functionality
5. Ensure all tests pass
6. Submit a pull request

## Security Considerations

- Credentials are stored using platform-specific secure storage
- Configuration files are validated before import
- Network traffic is encrypted using OpenVPN protocols
- No sensitive data is logged in production builds

## License

This project is licensed under the MIT License - see the LICENSE file for details.

## Acknowledgments

- Flutter team for the excellent cross-platform framework
- OpenVPN community for the robust VPN protocol
- Contributors and testers who helped improve the app

## Documentation

### Technical Documentation
- **[Technical Summary](TECHNICAL_SUMMARY.md)**: Complete technical implementation details
- **[Current Status](CurrentStatus.md)**: Latest project status and achievements
- **[VPN IP Display Fix](VPN_IP_DISPLAY_FIX.md)**: Detailed fix for VPN IP persistence issue
- **[Build Guide](BUILD_GUIDE.md)**: Step-by-step build instructions
- **[VPN Development Guide](VPN_DEVELOPMENT_GUIDE.md)**: VPN development best practices

## Support

For issues, feature requests, or questions:
1. Check existing issues in the repository
2. Create a new issue with detailed information
3. Include platform, Flutter version, and error logs
4. Refer to the technical documentation for implementation details

## Troubleshooting

### Common Issues

1. **NDK Version Mismatch**:
   - Ensure NDK 27.0.12077973 is installed
   - Remove conflicting NDK versions
   - Clean and rebuild: `flutter clean && flutter run`

2. **Native Library Not Found**:
   - Verify CMakeLists.txt configuration
   - Check NDK path in local.properties
   - Ensure native library compilation is enabled

3. **Foreground Service Errors**:
   - Verify `specialUse` service type configuration
   - Check Android 14+ permission requirements
   - Ensure proper service property declaration

4. **VPN IP Not Displaying**:
   - Ensure connection is fully established (status shows "connected")
   - Check that stats polling is working (look for periodic stats logs)
   - Verify JNI method includes `localIp` field in returned HashMap
   - Check Flutter type casting in `getConnectionStats()` method

---

**Note**: The Android implementation is fully functional with real OpenVPN3 integration. Other platforms are planned for future development.
