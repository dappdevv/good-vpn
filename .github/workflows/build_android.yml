name: –°–±–æ—Ä–∫–∞ Android APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        with:
          submodules: "recursive"

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Android SDK
        uses: android-actions/setup-android@v3

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ NDK (–≤–µ—Ä—Å–∏—è 27.0.12077973)
        run: |
          echo "y" | sdkmanager --install "ndk;27.0.12077973"
        shell: bash

      - name: –≠–∫—Å–ø–æ—Ä—Ç –ø—É—Ç–∏ –∫ NDK
        run: |
          NDK_PATH="${ANDROID_SDK_ROOT}/ndk/27.0.12077973"
          echo "ANDROID_NDK_ROOT=${NDK_PATH}" >> $GITHUB_ENV
          echo "ANDROID_NDK=${NDK_PATH}" >> $GITHUB_ENV
          echo "${NDK_PATH}/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH
        shell: bash

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
        run: |
          echo "–í–µ—Ä—Å–∏—è Flutter:"
          flutter --version
          echo "–í–µ—Ä—Å–∏—è Java:"
          java -version
          echo "ANDROID_SDK_ROOT: ${ANDROID_SDK_ROOT}"
          echo "ANDROID_NDK_ROOT: ${ANDROID_NDK_ROOT}"
          echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ NDK:"
          ls -la ${ANDROID_NDK_ROOT}
        shell: bash

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Flutter
        run: flutter pub get

      - name: –°–±–æ—Ä–∫–∞ Android –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä
        run: |
          # –°–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–≤—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ APK
          ABIS=("arm64-v8a" "armeabi-v7a" "x86_64" "x86")

          for abi in "${ABIS[@]}"; do
            echo "::group::–°–±–æ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π OpenVPN –¥–ª—è ${abi}"
            export ANDROID_ABI=${abi}
            (cd openvpn && ./build_android.sh)
            echo "::endgroup::"
          done

          echo "üî® –°–±–æ—Ä–∫–∞ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ Flutter APK (release)..."
          flutter build apk --release
        shell: bash

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ APK –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
        uses: actions/upload-artifact@v4
        with:
          name: good-vpn-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
